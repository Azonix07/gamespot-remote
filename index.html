<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Connection Test</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #1e1e2f;
      color: white;
    }
    
    .status {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    
    .online {
      background: rgba(76, 175, 80, 0.3);
      border: 1px solid #4CAF50;
    }
    
    .offline {
      background: rgba(244, 67, 54, 0.3);
      border: 1px solid #f44336;
    }
    
    .log {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      padding: 10px;
      margin-top: 20px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
    }
    
    .log-entry {
      margin-bottom: 5px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 5px;
    }
    
    .error { color: #ff6b6b; }
    .success { color: #6bff6b; }
    .info { color: #6bb5ff; }
    
    button {
      background: #ff6f00;
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    .payments {
      margin-top: 30px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      padding: 15px;
    }
    
    .payment-card {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
    }
    
    h1, h2 {
      color: #ff6f00;
    }
  </style>
</head>
<body>
  <h1>Firebase Connection Test</h1>
  
  <div id="connectionStatus" class="status offline">
    Connection Status: <span id="statusText">Checking...</span>
  </div>
  
  <div>
    <button id="checkConnection">Check Connection</button>
    <button id="testRead">Test Read</button>
    <button id="testWrite">Test Write</button>
    <button id="checkPending">Check Pending Payments</button>
  </div>
  
  <div id="configDisplay">
    <h3>Firebase Config:</h3>
    <pre id="configData"></pre>
  </div>
  
  <div class="payments">
    <h2>Pending Payments</h2>
    <div id="pendingPayments"></div>
  </div>
  
  <h3>Debug Log:</h3>
  <div class="log" id="logContainer"></div>

  <!-- Firebase v9 with CDN import (most compatible approach) -->
  <script type="module">
    // Import Firebase modules from CDN
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, onChildAdded } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

    // Log helper
    function log(message, type = 'info') {
      const logContainer = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.classList.add('log-entry', type);
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
      console.log(`[${type}] ${message}`);
    }
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDUIUj6uvUfWVxyHfgLWzahJAelrFqpIEc",
      authDomain: "gamespotkiosk.firebaseapp.com",
      databaseURL: "https://gamespotkiosk-default-rtdb.firebaseio.com",
      projectId: "gamespotkiosk",
      storageBucket: "gamespotkiosk.appspot.com",
      messagingSenderId: "537976874541",
      appId: "1:537976874541:web:9e847488e9fc6b78913aa4"
    };

    // Display the config (without API key)
    const configCopy = {...firebaseConfig};
    configCopy.apiKey = configCopy.apiKey.substr(0, 8) + '...';
    document.getElementById('configData').textContent = JSON.stringify(configCopy, null, 2);
    
    try {
      log("Initializing Firebase...");
      
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      log("Firebase app initialized", "success");
      
      // Initialize Realtime Database
      const database = getDatabase(app);
      log("Database initialized", "success");
      
      // Check connection status
      const connectedRef = ref(database, '.info/connected');
      onValue(connectedRef, (snapshot) => {
        const connected = snapshot.val();
        log(`Connection status: ${connected ? 'Connected' : 'Disconnected'}`, connected ? 'success' : 'error');
        
        // Update UI
        const statusElement = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');
        statusElement.className = `status ${connected ? 'online' : 'offline'}`;
        statusText.textContent = connected ? 'Connected' : 'Disconnected';
      });
      
      // Listen for pending payments
      const pendingRef = ref(database, 'pendingPayments');
      onChildAdded(pendingRef, (snapshot) => {
        const payment = snapshot.val();
        log(`New payment received: ${payment.id}`, 'success');
        updatePaymentsList();
      });
      
      // Button handlers
      document.getElementById('checkConnection').addEventListener('click', () => {
        log("Checking connection...");
        onValue(connectedRef, (snapshot) => {
          const connected = snapshot.val();
          log(`Connection status: ${connected ? 'Connected' : 'Disconnected'}`, connected ? 'success' : 'error');
        }, { onlyOnce: true });
      });
      
      document.getElementById('testRead').addEventListener('click', () => {
        log("Testing database read...");
        onValue(ref(database, 'test-read'), (snapshot) => {
          log(`Read successful: ${JSON.stringify(snapshot.val())}`, 'success');
        }, { onlyOnce: true });
      });
      
      document.getElementById('testWrite').addEventListener('click', async () => {
        log("Testing database write...");
        try {
          const testRef = ref(database, 'test-write');
          await set(testRef, {
            timestamp: Date.now(),
            test: 'Connection test'
          });
          log("Write successful", 'success');
        } catch (error) {
          log(`Write error: ${error.message}`, 'error');
        }
      });
      
      document.getElementById('checkPending').addEventListener('click', () => {
        log("Checking pending payments...");
        updatePaymentsList();
      });
      
      // Function to update payments list
      function updatePaymentsList() {
        const paymentsContainer = document.getElementById('pendingPayments');
        
        onValue(pendingRef, (snapshot) => {
          const payments = snapshot.val();
          
          if (payments) {
            const count = Object.keys(payments).length;
            log(`Found ${count} pending payments`, 'info');
            
            let html = '';
            Object.values(payments).forEach(payment => {
              html += `
                <div class="payment-card">
                  <div><strong>${payment.console}</strong> - ${payment.method}</div>
                  <div>Amount: â‚¹${payment.amount} - Duration: ${payment.minutes} min</div>
                  <div>Created: ${new Date(payment.createdAt).toLocaleString()}</div>
                </div>
              `;
            });
            
            paymentsContainer.innerHTML = html;
          } else {
            log("No pending payments found", 'info');
            paymentsContainer.innerHTML = '<p>No pending payments found</p>';
          }
        }, { onlyOnce: true });
      }
      
      // Initial check for payments
      updatePaymentsList();
      
    } catch (error) {
      log(`Firebase initialization error: ${error.message}`, 'error');
    }
  </script>
</body>
</html>
