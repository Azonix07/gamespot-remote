<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gamespot Remote Control</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Basic Styling */
    body {
      font-family: 'Poppins', sans-serif;
      background: #1e1e2f;
      color: white;
      margin: 0;
      padding: 20px;
      padding-top: 60px;
    }
    
    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #121212;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .logo {
      color: #ff6f00;
      font-weight: bold;
      font-size: 20px;
    }
    
    .status {
      display: flex;
      align-items: center;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    .online {
      background-color: #4CAF50;
      box-shadow: 0 0 5px #4CAF50;
    }
    
    .offline {
      background-color: #f44336;
      box-shadow: 0 0 5px #f44336;
    }
    
    /* Login */
    .login-container {
      max-width: 400px;
      margin: 0 auto;
      background: rgba(30, 30, 47, 0.8);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      text-align: center;
    }
    
    .pin-display {
      font-size: 30px;
      letter-spacing: 10px;
      margin: 20px 0;
      background: rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: 5px;
    }
    
    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .key {
      padding: 15px;
      background: rgba(255,111,0,0.2);
      border-radius: 5px;
      cursor: pointer;
      user-select: none;
      font-size: 20px;
    }
    
    .key:active {
      background: rgba(255,111,0,0.4);
      transform: scale(0.98);
    }
    
    .login-btn {
      background: #ff6f00;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    /* Control Panel */
    .control-panel {
      max-width: 600px;
      margin: 0 auto;
      display: none;
    }
    
    .section {
      background: rgba(30, 30, 47, 0.8);
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 10px;
    }
    
    .section h2 {
      color: #ff6f00;
      margin-top: 0;
      font-size: 20px;
      margin-bottom: 15px;
    }
    
    .payment-card {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .payment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .payment-console {
      font-weight: bold;
      font-size: 18px;
    }
    
    .payment-time {
      opacity: 0.7;
      font-size: 14px;
    }
    
    .payment-details {
      margin-bottom: 15px;
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .label {
      opacity: 0.7;
    }
    
    .value {
      font-weight: 500;
    }
    
    .amount {
      color: #ff6f00;
      font-weight: bold;
    }
    
    .buttons {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      padding: 10px;
      flex: 1;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .btn-confirm {
      background: #4CAF50;
      color: white;
    }
    
    .btn-cancel {
      background: #f44336;
      color: white;
    }
    
    .no-payments {
      text-align: center;
      padding: 20px;
      opacity: 0.7;
    }
    
    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .action-btn {
      background: rgba(255,111,0,0.2);
      padding: 12px;
      text-align: center;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .action-btn:active {
      background: rgba(255,111,0,0.3);
    }
    
    .logout {
      background: rgba(0,0,0,0.3);
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 200;
      transform: translateY(-100%);
      transition: transform 0.3s;
    }
    
    .alert.show {
      transform: translateY(0);
    }
    
    .alert-success {
      background: rgba(76,175,80,0.9);
    }
    
    .alert-error {
      background: rgba(244,67,54,0.9);
    }
    
    .alert-info {
      background: rgba(33,150,243,0.9);
    }
    
    .payment-alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 300;
      display: none;
    }
    
    .alert-container {
      background: #1e1e2f;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 350px;
      border: 2px solid #ff6f00;
    }
    
    .alert-title {
      color: #ff6f00;
      font-size: 20px;
      text-align: center;
      margin-bottom: 15px;
    }
    
    .alert-content {
      margin-bottom: 20px;
    }
    
    .alert-amount {
      font-size: 24px;
      text-align: center;
      font-weight: bold;
      margin: 15px 0;
    }
    
    .alert-buttons {
      display: flex;
      gap: 10px;
    }
    
    .badge {
      position: fixed;
      top: 60px;
      right: 20px;
      background: #f44336;
      color: white;
      min-width: 20px;
      height: 20px;
      border-radius: 10px;
      text-align: center;
      line-height: 20px;
      font-size: 12px;
      display: none;
      z-index: 150;
      padding: 0 5px;
    }
    
    .debug {
      position: fixed;
      bottom: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 5px;
      z-index: 400;
    }
    
    .debug-btn {
      background: #333;
      color: white;
      border: none;
      padding: 5px 8px;
      font-size: 10px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="logo">Gamespot Remote</div>
    <div class="status">
      <span class="status-dot offline" id="statusDot"></span>
      <span id="statusText">Offline</span>
    </div>
  </div>
  
  <!-- Notification Badge -->
  <div class="badge" id="badge"></div>
  
  <!-- Login Panel -->
  <div id="loginPanel" class="login-container">
    <h1 style="margin-top: 0; color: #ff6f00;">Admin Login</h1>
    <div class="pin-display" id="pinDisplay">****</div>
    <div class="keypad">
      <div class="key" onclick="addDigit('1')">1</div>
      <div class="key" onclick="addDigit('2')">2</div>
      <div class="key" onclick="addDigit('3')">3</div>
      <div class="key" onclick="addDigit('4')">4</div>
      <div class="key" onclick="addDigit('5')">5</div>
      <div class="key" onclick="addDigit('6')">6</div>
      <div class="key" onclick="addDigit('7')">7</div>
      <div class="key" onclick="addDigit('8')">8</div>
      <div class="key" onclick="addDigit('9')">9</div>
      <div class="key" onclick="clearPin()">Clear</div>
      <div class="key" onclick="addDigit('0')">0</div>
      <div class="key" onclick="deleteDigit()">⌫</div>
    </div>
    <button class="login-btn" onclick="login()">Login</button>
  </div>
  
  <!-- Control Panel -->
  <div id="controlPanel" class="control-panel">
    <div class="section">
      <h2>Pending Payments</h2>
      <div id="paymentsList">
        <div class="no-payments">No pending payments</div>
      </div>
    </div>
    
    <div class="section">
      <h2>Quick Actions</h2>
      <div class="action-grid">
        <div class="action-btn" onclick="refreshPayments()">Refresh</div>
        <div class="action-btn" onclick="backToHome()">Home</div>
        <div class="action-btn" onclick="checkStatus()">Status</div>
        <div class="action-btn" onclick="resetAll()">Reset All</div>
      </div>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </div>
  
  <!-- Alert -->
  <div class="alert" id="alert"></div>
  
  <!-- Payment Alert -->
  <div class="payment-alert" id="paymentAlert">
    <div class="alert-container">
      <div class="alert-title">New Payment Request</div>
      <div class="alert-content">
        <div class="detail-row">
          <span class="label">Console:</span>
          <span class="value" id="alertConsole">PS5</span>
        </div>
        <div class="detail-row">
          <span class="label">Duration:</span>
          <span class="value" id="alertDuration">60 min</span>
        </div>
        <div class="detail-row">
          <span class="label">Players:</span>
          <span class="value" id="alertPlayers">2</span>
        </div>
        <div class="alert-amount">₹<span id="alertAmount">150</span></div>
      </div>
      <div class="alert-buttons">
        <button class="btn btn-confirm" id="alertConfirm">Confirm</button>
        <button class="btn btn-cancel" id="alertCancel">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Debug Buttons -->
  <div class="debug">
    <button class="debug-btn" onclick="testConnection()">Test Connection</button>
    <button class="debug-btn" onclick="testWrite()">Test Write</button>
    <button class="debug-btn" onclick="checkPending()">Check Pending</button>
  </div>
  
  <!-- Firebase Scripts -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, remove, set, onChildAdded, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDUIUj6uvUfWVxyHfgLWzahJAelrFqpIEc",
      authDomain: "gamespotkiosk.firebaseapp.com",
      databaseURL: "https://gamespotkiosk-default-rtdb.firebaseio.com",
      projectId: "gamespotkiosk",
      storageBucket: "gamespotkiosk.appspot.com",
      messagingSenderId: "537976874541",
      appId: "1:537976874541:web:9e847488e9fc6b78913aa4",
      measurementId: "G-SGD83SS6D1"
    };
    
    // Initialize Firebase with more modern imports
    const app = initializeApp(firebaseConfig);
    const database = getDatabase();
    
    // State variables
    let pin = '';
    let pendingPayments = [];
    let notificationCount = 0;
    let currentPaymentId = null;
    
    // Constants
    const ADMIN_PIN = '6006';
    
    // Make functions global for HTML button onclick
    window.addDigit = function(digit) {
      if (pin.length < 4) {
        pin += digit;
        updatePinDisplay();
      }
    };
    
    window.clearPin = function() {
      pin = '';
      updatePinDisplay();
    };
    
    window.deleteDigit = function() {
      pin = pin.slice(0, -1);
      updatePinDisplay();
    };
    
    window.updatePinDisplay = function() {
      document.getElementById('pinDisplay').textContent = '*'.repeat(pin.length).padEnd(4, '*');
    };
    
    window.login = function() {
      if (pin === ADMIN_PIN) {
        document.getElementById('loginPanel').style.display = 'none';
        document.getElementById('controlPanel').style.display = 'block';
        showAlert('Login successful', 'success');
        
        // Save login
        localStorage.setItem('isLoggedIn', 'true');
        
        // Start listening for payments
        setupFirebaseListeners();
        fetchPendingPayments();
      } else {
        showAlert('Invalid PIN', 'error');
        clearPin();
      }
    };
    
    window.logout = function() {
      document.getElementById('loginPanel').style.display = 'block';
      document.getElementById('controlPanel').style.display = 'none';
      pin = '';
      updatePinDisplay();
      
      // Clear login
      localStorage.removeItem('isLoggedIn');
      
      // Stop listening
      // For this simple version, we'll just refresh the page on logout
      setTimeout(() => {
        location.reload();
      }, 500);
    };
    
    window.refreshPayments = function() {
      showAlert('Refreshing...', 'info');
      fetchPendingPayments();
    };
    
    window.backToHome = function() {
      showAlert('Sending home command...', 'info');
      push(ref(database, 'commands'), {
        type: 'redirect',
        page: 'index.html',
        timestamp: Date.now()
      }).then(() => {
        showAlert('Home command sent', 'success');
      }).catch(err => {
        showAlert('Error: ' + err.message, 'error');
      });
    };
    
    window.checkStatus = function() {
      showAlert('Checking connection...', 'info');
      // The connection status should auto-update from Firebase
      setTimeout(() => {
        const isOnline = document.getElementById('statusDot').classList.contains('online');
        showAlert(isOnline ? 'Connected to Firebase' : 'Not connected to Firebase', isOnline ? 'success' : 'error');
      }, 500);
    };
    
    window.resetAll = function() {
      if (confirm('Are you sure you want to reset all devices?')) {
        push(ref(database, 'commands'), {
          type: 'reset',
          timestamp: Date.now()
        }).then(() => {
          showAlert('Reset command sent', 'success');
        }).catch(err => {
          showAlert('Error: ' + err.message, 'error');
        });
      }
    };
    
    // Test functions
    window.testConnection = function() {
      showAlert('Testing connection...', 'info');
      onValue(ref(database, '.info/connected'), (snapshot) => {
        const connected = snapshot.val();
        showAlert(connected ? 'Connected to Firebase' : 'Not connected to Firebase', connected ? 'success' : 'error');
      }, { onlyOnce: true });
    };
    
    window.testWrite = function() {
      set(ref(database, 'test-write'), {
        timestamp: Date.now(),
        device: 'remote'
      }).then(() => {
        showAlert('Write test successful', 'success');
      }).catch(err => {
        showAlert('Write failed: ' + err.message, 'error');
      });
    };
    
    window.checkPending = function() {
      showAlert('Checking pending payments...', 'info');
      onValue(ref(database, 'pendingPayments'), (snapshot) => {
        const data = snapshot.val();
        if (data) {
          const count = Object.keys(data).length;
          showAlert(`Found ${count} pending payment(s)`, 'info');
          console.log("Pending payments:", data);
        } else {
          showAlert('No pending payments found', 'info');
        }
      }, { onlyOnce: true });
    };
    
    function setupFirebaseListeners() {
      // Connection status
      onValue(ref(database, '.info/connected'), (snapshot) => {
        const connected = snapshot.val();
        updateConnectionStatus(connected);
      });
      
      // Pending payments
      onChildAdded(ref(database, 'pendingPayments'), (snapshot) => {
        const payment = snapshot.val();
        if (payment) {
          // Check if already in our list
          const index = pendingPayments.findIndex(p => p.id === payment.id);
          if (index === -1) {
            pendingPayments.push(payment);
            updatePaymentsList();
            showNotification(payment);
            
            // Update badge
            notificationCount++;
            updateBadge();
          }
        }
      });
      
      onChildRemoved(ref(database, 'pendingPayments'), (snapshot) => {
        const payment = snapshot.val();
        if (payment) {
          // Remove from list
          pendingPayments = pendingPayments.filter(p => p.id !== payment.id);
          updatePaymentsList();
          
          // Update badge
          notificationCount = Math.max(0, notificationCount - 1);
          updateBadge();
          
          // Hide alert if showing this payment
          if (currentPaymentId === payment.id) {
            hidePaymentAlert();
          }
        }
      });
    }
    
    async function fetchPendingPayments() {
      try {
        const snapshot = await new Promise((resolve) => {
          onValue(ref(database, 'pendingPayments'), resolve, { onlyOnce: true });
        });
        
        const data = snapshot.val();
        pendingPayments = data ? Object.values(data) : [];
        updatePaymentsList();
        
        // Update badge
        notificationCount = pendingPayments.length;
        updateBadge();
        
        return pendingPayments;
      } catch (error) {
        console.error('Error fetching payments:', error);
        showAlert('Failed to fetch payments', 'error');
        return [];
      }
    }
    
    function updatePaymentsList() {
      const container = document.getElementById('paymentsList');
      
      if (!pendingPayments || pendingPayments.length === 0) {
        container.innerHTML = '<div class="no-payments">No pending payments</div>';
        return;
      }
      
      let html = '';
      pendingPayments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(payment => {
        const time = new Date(payment.createdAt).toLocaleTimeString();
        
        html += `
          <div class="payment-card">
            <div class="payment-header">
              <div class="payment-console">${payment.console}</div>
              <div class="payment-time">${time}</div>
            </div>
            <div class="payment-details">
              <div class="detail-row">
                <span class="label">Duration:</span>
                <span class="value">${payment.minutes} min</span>
              </div>
              <div class="detail-row">
                <span class="label">Method:</span>
                <span class="value">${payment.method}</span>
              </div>
              <div class="detail-row">
                <span class="label">Players:</span>
                <span class="value">${payment.players || 1}</span>
              </div>
              <div class="detail-row">
                <span class="label">Amount:</span>
                <span class="amount">₹${payment.amount}</span>
              </div>
            </div>
            <div class="buttons">
              <button class="btn btn-confirm" onclick="confirmPayment('${payment.id}')">Confirm</button>
              <button class="btn btn-cancel" onclick="cancelPayment('${payment.id}')">Cancel</button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    window.confirmPayment = async function(paymentId) {
      const payment = pendingPayments.find(p => p.id === paymentId);
      if (!payment) return;
      
      showAlert('Confirming payment...', 'info');
      
      try {
        // Move to confirmed
        await set(ref(database, `confirmedPayments/${paymentId}`), payment);
        
        // Remove from pending
        await remove(ref(database, `pendingPayments/${paymentId}`));
        
        showAlert('Payment confirmed', 'success');
      } catch (error) {
        console.error('Error confirming payment:', error);
        showAlert('Error confirming payment', 'error');
      }
    };
    
    window.cancelPayment = async function(paymentId) {
      const payment = pendingPayments.find(p => p.id === paymentId);
      if (!payment) return;
      
      showAlert('Canceling payment...', 'info');
      
      try {
        // Move to canceled
        await set(ref(database, `canceledPayments/${paymentId}`), payment);
        
        // Remove from pending
        await remove(ref(database, `pendingPayments/${paymentId}`));
        
        showAlert('Payment canceled', 'success');
      } catch (error) {
        console.error('Error canceling payment:', error);
        showAlert('Error canceling payment', 'error');
      }
    };
    
    function showNotification(payment) {
      // Show payment alert
      currentPaymentId = payment.id;
      
      document.getElementById('alertConsole').textContent = payment.console;
      document.getElementById('alertDuration').textContent = `${payment.minutes} min`;
      document.getElementById('alertPlayers').textContent = payment.players || 1;
      document.getElementById('alertAmount').textContent = payment.amount;
      
      document.getElementById('alertConfirm').onclick = () => {
        confirmPayment(payment.id);
        hidePaymentAlert();
      };
      
      document.getElementById('alertCancel').onclick = () => {
        cancelPayment(payment.id);
        hidePaymentAlert();
      };
      
      document.getElementById('paymentAlert').style.display = 'flex';
      
      // Vibrate if supported
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
      }
      
      // Play sound
      try {
        const audio = new Audio('https://raw.githubusercontent.com/twbs/bootstrap/main/site/assets/js/vendor/notification.mp3');
        audio.play().catch(e => console.log('Could not play sound:', e));
      } catch (e) {
        console.log('Error playing notification sound:', e);
      }
    }
    
    function hidePaymentAlert() {
      document.getElementById('paymentAlert').style.display = 'none';
      currentPaymentId = null;
      
      // Show next payment if available
      if (pendingPayments.length > 0 && !currentPaymentId) {
        setTimeout(() => {
          showNotification(pendingPayments[0]);
        }, 500);
      }
    }
    
    function updateConnectionStatus(connected) {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      
      statusDot.className = `status-dot ${connected ? 'online' : 'offline'}`;
      statusText.textContent = connected ? 'Connected' : 'Offline';
    }
    
    function updateBadge() {
      const badge = document.getElementById('badge');
      
      if (notificationCount > 0) {
        badge.textContent = notificationCount;
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function showAlert(message, type) {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert alert-${type} show`;
      
      setTimeout(() => {
        alert.classList.remove('show');
      }, 3000);
    }
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('isLoggedIn') === 'true') {
        login(); // Auto login
      }
      
      // Check connection status on startup
      testConnection();
    });
  </script>
</body>
</html>
