<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gamespot Remote</title>
  <!-- Prevent iOS from applying its own styling -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-title" content="Gamespot">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2993/2993063.png">
  <!-- iOS splash screens -->
  <link rel="apple-touch-startup-image" href="https://cdn-icons-png.flaticon.com/512/2993/2993063.png">
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- EmailJS Library -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    /* Reset and base styles optimized for iOS */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      background-color: #121212;
      color: white;
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    body {
      padding-top: 60px;
      padding-bottom: 20px;
    }
    
    /* Header - iOS style */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(18, 18, 18, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px); /* For Safari */
      z-index: 1000;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 0 rgba(255,255,255,0.1);
    }
    
    .logo {
      color: #ff6f00;
      font-weight: bold;
      font-size: 20px;
    }
    
    .status {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .online {
      background: #4CAF50;
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
    }
    
    .offline {
      background: #f44336;
      box-shadow: 0 0 10px rgba(244, 67, 54, 0.7);
    }
    
    /* Container */
    .container {
      padding: 15px;
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* Login panel - iOS style */
    .login-panel {
      background: rgba(30, 30, 47, 0.8);
      border-radius: 12px;
      padding: 25px 20px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .login-title {
      color: #ff6f00;
      font-size: 24px;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    .pin-display {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      font-size: 26px;
      letter-spacing: 8px;
      margin-bottom: 20px;
    }
    
    /* iOS-style numpad */
    .numpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .key {
      background: rgba(255, 111, 0, 0.2);
      border-radius: 50%;
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 500;
      transition: all 0.1s;
      cursor: pointer;
    }
    
    .key:active {
      transform: scale(0.95);
      background: rgba(255, 111, 0, 0.4);
    }
    
    /* iOS-style buttons */
    .btn {
      background: #ff6f00;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 15px;
      width: 100%;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s;
    }
    
    .btn:active {
      transform: scale(0.98);
      background: #e65100;
    }
    
    /* Panel section */
    .panel {
      background: rgba(30, 30, 47, 0.8);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .panel-title {
      color: #ff6f00;
      font-size: 20px;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .no-items {
      text-align: center;
      padding: 30px 0;
      color: rgba(255, 255, 255, 0.6);
    }
    
    /* Payment card - iOS style */
    .payment-card {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      animation: fadeIn 0.3s ease-out;
      position: relative;
    }
    
    .payment-card.new {
      animation: highlight 2s ease;
    }
    
    @keyframes highlight {
      0%, 20% { background-color: rgba(255, 111, 0, 0.3); }
      100% { background-color: rgba(0, 0, 0, 0.3); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .payment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .payment-console {
      font-weight: bold;
      font-size: 18px;
    }
    
    .payment-time {
      opacity: 0.7;
      font-size: 14px;
    }
    
    .payment-info {
      margin-bottom: 15px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    
    .info-label {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .info-value {
      font-weight: 500;
    }
    
    .amount {
      color: #ff6f00;
      font-weight: 600;
      font-size: 18px;
    }
    
    .payment-actions {
      display: flex;
      gap: 10px;
    }
    
    .action-btn {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
    }
    
    .btn-confirm {
      background: #4CAF50;
      color: white;
    }
    
    .btn-cancel {
      background: #f44336;
      color: white;
    }
    
    .btn-call {
      background: #2196F3;
      color: white;
    }
    
    .action-btn:active {
      opacity: 0.8;
      transform: scale(0.98);
    }
    
    /* Quick actions - iOS style */
    .action-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 15px;
    }
    
    .action-item {
      background: rgba(255, 111, 0, 0.15);
      border-radius: 10px;
      padding: 15px 0;
      text-align: center;
      font-weight: 500;
      cursor: pointer;
    }
    
    .action-item:active {
      background: rgba(255, 111, 0, 0.3);
      transform: scale(0.98);
    }
    
    .logout-btn {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 12px 0;
      text-align: center;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
      color: white;
      border: none;
      font-size: 16px;
    }
    
    /* iOS-style notification */
    .notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 12px 15px;
      color: white;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
      opacity: 0;
      transform: translateX(-50%) translateY(-100%);
    }
    
    .notification.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    .notification-icon {
      width: 30px;
      height: 30px;
      background: #ff6f00;
      border-radius: 6px;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .notification-message {
      font-size: 14px;
      opacity: 0.8;
    }
    
    /* Payment Alert Modal - iOS style */
    .alert-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .alert-container {
      width: 100%;
      max-width: 320px;
      background: #1e1e2f;
      border-radius: 14px;
      overflow: hidden;
    }
    
    .alert-header {
      background: rgba(255, 111, 0, 0.2);
      padding: 15px;
      text-align: center;
    }
    
    .alert-title {
      color: #ff6f00;
      font-size: 20px;
      font-weight: 600;
    }
    
    .alert-body {
      padding: 20px;
    }
    
    .alert-details {
      margin-bottom: 20px;
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .detail-label {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .alert-amount {
      font-size: 28px;
      text-align: center;
      font-weight: 700;
      margin: 20px 0;
      color: #ff6f00;
    }
    
    .alert-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 0 20px 20px;
    }
    
    .alert-btn {
      padding: 15px 0;
      text-align: center;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 10px;
      color: white;
    }
    
    /* Call button and timer */
    .call-action {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 15px;
    }
    
    .call-btn {
      background: #2196F3;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 15px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .call-icon {
      font-size: 20px;
    }
    
    .call-timer {
      background: rgba(0,0,0,0.3);
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      display: none;
    }
    
    /* Badge for notification count */
    .badge {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #f44336;
      color: white;
      min-width: 20px;
      height: 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      padding: 0 6px;
      z-index: 1100;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    
    /* Sound toggle - iOS style */
    .sound-toggle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 1100;
      font-size: 18px;
    }
    
    /* Auto call panel */
    .auto-call {
      margin-top: 10px;
      padding: 10px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
      font-size: 14px;
    }
    
    .auto-call-label {
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 5px;
    }
    
    .auto-call-toggle {
      background: rgba(255, 111, 0, 0.2);
      border-radius: 15px;
      padding: 5px 10px;
      display: inline-flex;
      align-items: center;
      position: relative;
      cursor: pointer;
    }
    
    .toggle-switch {
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: all 0.3s ease;
    }
    
    .toggle-text {
      margin-left: 30px;
      font-weight: 500;
    }
    
    .auto-call-toggle.active {
      background: rgba(76, 175, 80, 0.5);
    }
    
    .auto-call-toggle.active .toggle-switch {
      transform: translateX(24px);
    }

    /* NEW: Email notification settings */
    .email-settings {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }
    
    .settings-title {
      color: #ff6f00;
      margin-bottom: 10px;
      font-size: 16px;
      font-weight: 500;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
      font-size: 16px;
      font-family: inherit;
    }
    
    /* For debugging */
    .debug-panel {
      position: fixed;
      bottom: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 5px;
      z-index: 3000;
    }
    
    .debug-btn {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 5px 8px;
      font-size: 10px;
      border-radius: 4px;
    }
    
    /* NEW: Timer bar */
    .timer-bar-container {
      width: 100%;
      height: 4px;
      background-color: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 10px;
      margin-bottom: 5px;
    }
    
    .timer-bar {
      height: 100%;
      background-color: #ff6f00;
      width: 100%;
      transition: width 1s linear;
    }
    
    .timer-text {
      font-size: 12px;
      color: rgba(255,255,255,0.7);
      text-align: center;
      margin-bottom: 10px;
    }
    
    /* Expires soon animation */
    @keyframes pulse {
      0% { background-color: rgba(255,0,0,0.1); }
      50% { background-color: rgba(255,0,0,0.3); }
      100% { background-color: rgba(255,0,0,0.1); }
    }
    
    .expires-soon {
      animation: pulse 1s infinite;
    }
    
    /* NEW: Auto-confirmed badge */
    .payment-status-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: bold;
      z-index: 5;
    }
    
    .detecting-badge {
      background-color: #ff9800;
      color: black;
    }
    
    .confirmed-badge {
      background-color: #4CAF50;
      color: white;
    }
    
    .expired-badge {
      background-color: #f44336;
      color: white;
    }
    
    .waiting-badge {
      background-color: #2196F3;
      color: white;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="logo">Gamespot Remote</div>
    <div class="status">
      <div id="statusIndicator" class="status-indicator offline"></div>
      <div id="statusText">Offline</div>
    </div>
  </div>
  
  <!-- Container -->
  <div class="container">
    <!-- Login Panel -->
    <div id="loginPanel" class="login-panel">
      <div class="login-title">Admin Login</div>
      <div id="pinDisplay" class="pin-display">****</div>
      <div class="numpad">
        <div class="key" onclick="addDigit(1)">1</div>
        <div class="key" onclick="addDigit(2)">2</div>
        <div class="key" onclick="addDigit(3)">3</div>
        <div class="key" onclick="addDigit(4)">4</div>
        <div class="key" onclick="addDigit(5)">5</div>
        <div class="key" onclick="addDigit(6)">6</div>
        <div class="key" onclick="addDigit(7)">7</div>
        <div class="key" onclick="addDigit(8)">8</div>
        <div class="key" onclick="addDigit(9)">9</div>
        <div class="key" onclick="clearPin()">C</div>
        <div class="key" onclick="addDigit(0)">0</div>
        <div class="key" onclick="deleteDigit()">‚å´</div>
      </div>
      <button class="btn" onclick="login()">Login</button>
      
      <!-- Auto Call Setting -->
      <div class="auto-call">
        <div class="auto-call-label">Auto Call on New Payment</div>
        <div id="autoCallToggle" class="auto-call-toggle active" onclick="toggleAutoCall()">
          <div class="toggle-switch"></div>
          <div class="toggle-text">ON</div>
        </div>
      </div>

      <!-- Email Notification Settings -->
      <div class="email-settings">
        <div class="settings-title">Email Notifications</div>
        <div class="form-group">
          <input type="email" id="emailAddress" placeholder="your.email@example.com" />
        </div>
        <div class="auto-call-toggle" id="emailToggle" onclick="toggleEmailNotifications()">
          <div class="toggle-switch"></div>
          <div class="toggle-text">OFF</div>
        </div>
      </div>
    </div>
    
    <!-- Main Panel (initially hidden) -->
    <div id="mainPanel" style="display: none;">
      <!-- Payments Panel -->
      <div class="panel">
        <div class="panel-title">Pending Payments</div>
        <div id="paymentsContainer">
          <div class="no-items">No pending payments</div>
        </div>
      </div>
      
      <!-- Email Settings Panel -->
      <div class="panel">
        <div class="panel-title">Notification Settings</div>
        
        <!-- Auto Call Setting -->
        <div class="auto-call">
          <div class="auto-call-label">Auto Call on New Payment</div>
          <div id="mainAutoCallToggle" class="auto-call-toggle active" onclick="toggleAutoCall()">
            <div class="toggle-switch"></div>
            <div class="toggle-text">ON</div>
          </div>
        </div>

        <!-- Email Notifications -->
        <div class="email-settings">
          <div class="settings-title">Email Notifications</div>
          <div class="form-group">
            <input type="email" id="mainEmailAddress" placeholder="your.email@example.com" />
          </div>
          <div class="auto-call-toggle" id="mainEmailToggle" onclick="toggleEmailNotifications()">
            <div class="toggle-switch"></div>
            <div class="toggle-text">OFF</div>
          </div>
          <div id="emailStatus" style="margin-top:10px;font-size:14px;color:#aaa;text-align:center;"></div>
          <button class="btn" style="margin-top:15px" onclick="saveEmailSettings()">Save Email Settings</button>
        </div>
      </div>
      
      <!-- Quick Actions Panel -->
      <div class="panel">
        <div class="panel-title">Quick Actions</div>
        <div class="action-grid">
          <div class="action-item" onclick="refreshPayments()">Refresh</div>
          <div class="action-item" onclick="backToHome()">Home</div>
          <div class="action-item" onclick="checkStatus()">Status</div>
          <div class="action-item" onclick="resetAll()">Reset All</div>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>
  
  <!-- Notification Badge -->
  <div id="badge" class="badge" style="display: none;">0</div>
  
  <!-- Sound Toggle -->
  <div id="soundToggle" class="sound-toggle" onclick="toggleSound()">üîî</div>
  
  <!-- Toast Notification -->
  <div id="notification" class="notification">
    <div class="notification-icon">‚Çπ</div>
    <div class="notification-content">
      <div class="notification-title">New Payment</div>
      <div class="notification-message">PS5 - ‚Çπ150</div>
    </div>
  </div>
  
  <!-- Payment Alert Modal -->
  <div id="alertModal" class="alert-modal">
    <div class="alert-container">
      <div class="alert-header">
        <div class="alert-title">New Payment Request</div>
      </div>
      <div class="alert-body">
        <div class="alert-details">
          <div class="detail-item">
            <div class="detail-label">Console:</div>
            <div id="alertConsole" class="detail-value">PS5</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Duration:</div>
            <div id="alertDuration" class="detail-value">60 min</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Players:</div>
            <div id="alertPlayers" class="detail-value">2</div>
          </div>
        </div>
        <div id="alertAmount" class="alert-amount">‚Çπ150</div>
        
        <!-- NEW: Expiry Timer -->
        <div class="timer-bar-container">
          <div id="alertTimerBar" class="timer-bar"></div>
        </div>
        <div id="alertTimerText" class="timer-text">Expires in 2:30</div>
        
        <!-- Call Action -->
        <div class="call-action">
          <div id="callBtn" class="call-btn" onclick="callAdmin()">
            <span class="call-icon">üìû</span>
            <span>Call Admin (7012125919)</span>
          </div>
          <div id="callTimer" class="call-timer">
            Call will auto-end in <span id="timeLeft">15</span> seconds
          </div>
        </div>
      </div>
      <div class="alert-actions">
        <button id="alertConfirm" class="alert-btn btn-confirm">Confirm</button>
        <button id="alertCancel" class="alert-btn btn-cancel">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Debug Panel -->
  <div class="debug-panel">
    <button class="debug-btn" onclick="testConnection()">Test Connection</button>
    <button class="debug-btn" onclick="testSound()">Test Sound</button>
    <button class="debug-btn" onclick="testCall()">Test Call</button>
    <button class="debug-btn" onclick="testEmail()">Test Email</button>
    <button class="debug-btn" onclick="simulatePaytmSound()">Simulate Paytm</button>
  </div>
  
  <!-- Audio Elements -->
  <audio id="notificationSound" preload="auto">
    <source src="https://raw.githubusercontent.com/twbs/bootstrap/main/site/assets/js/vendor/notification.mp3" type="audio/mp3">
  </audio>
  <audio id="errorSound" preload="auto">
    <source src="https://raw.githubusercontent.com/twbs/bootstrap/main/site/assets/js/vendor/alert.mp3" type="audio/mp3">
  </audio>
  
  <!-- Firebase SDK v8 (most iOS compatible) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script>
    // Initialize EmailJS - REPLACE WITH YOUR OWN KEYS
    (function() {
      emailjs.init("XaMrDuFYzVnTF9Uc_"); // ‚Üê Replace with your EmailJS Public Key
    })();

    // Firebase configuration with correct Asia-Southeast1 URL
    const firebaseConfig = {
      apiKey: "AIzaSyDUIUj6uvUfWVxyHfgLWzahJAelrFqpIEc",
      authDomain: "gamespotkiosk.firebaseapp.com",
      databaseURL: "https://gamespotkiosk-default-rtdb.asia-southeast1.firebasedatabase.app", 
      projectId: "gamespotkiosk",
      storageBucket: "gamespotkiosk.appspot.com",
      messagingSenderId: "537976874541",
      appId: "1:537976874541:web:9e847488e9fc6b78913aa4",
      measurementId: "G-SGD83SS6D1"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    console.log("Firebase initialization attempted");
    
    // Get database reference
    const database = firebase.database();
    
    // State variables
    let pin = '';
    const ADMIN_PIN = '6006';
    let isLoggedIn = false;
    let pendingPayments = [];
    let notificationCount = 0;
    let currentPaymentId = null;
    let soundEnabled = true;
    let autoCallEnabled = true;
    let emailNotificationsEnabled = false;
    let userEmail = '';
    let processedPayments = new Set(); // Track already processed payments
    const ADMIN_PHONE = "7012125919";
    const CALL_DURATION = 15; // 15 seconds
    const PAYMENT_EXPIRY_TIME = 2.5 * 60 * 1000; // 2.5 minutes in milliseconds
    let paymentTimers = {}; // Track timers for each payment
    let callTimerId = null; // Track call timer
    
    // DOM elements
    const loginPanel = document.getElementById('loginPanel');
    const mainPanel = document.getElementById('mainPanel');
    const pinDisplay = document.getElementById('pinDisplay');
    const paymentsContainer = document.getElementById('paymentsContainer');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const badge = document.getElementById('badge');
    const soundToggle = document.getElementById('soundToggle');
    const notification = document.getElementById('notification');
    const alertModal = document.getElementById('alertModal');
    const alertConsole = document.getElementById('alertConsole');
    const alertDuration = document.getElementById('alertDuration');
    const alertPlayers = document.getElementById('alertPlayers');
    const alertAmount = document.getElementById('alertAmount');
    const alertConfirm = document.getElementById('alertConfirm');
    const alertCancel = document.getElementById('alertCancel');
    const alertTimerBar = document.getElementById('alertTimerBar');
    const alertTimerText = document.getElementById('alertTimerText');
    const callBtn = document.getElementById('callBtn');
    const callTimer = document.getElementById('callTimer');
    const timeLeft = document.getElementById('timeLeft');
    const autoCallToggle = document.getElementById('autoCallToggle');
    const mainAutoCallToggle = document.getElementById('mainAutoCallToggle');
    const notificationSound = document.getElementById('notificationSound');
    const errorSound = document.getElementById('errorSound');
    const emailToggle = document.getElementById('emailToggle');
    const mainEmailToggle = document.getElementById('mainEmailToggle');
    const emailAddress = document.getElementById('emailAddress');
    const mainEmailAddress = document.getElementById('mainEmailAddress');
    const emailStatus = document.getElementById('emailStatus');
    
    // Load saved email settings
    const savedEmail = localStorage.getItem('userEmail');
    if (savedEmail) {
      userEmail = savedEmail;
      emailAddress.value = userEmail;
      mainEmailAddress.value = userEmail;
    }
    
    const emailEnabled = localStorage.getItem('emailNotifications');
    if (emailEnabled === 'true') {
      emailNotificationsEnabled = true;
      emailToggle.classList.add('active');
      mainEmailToggle.classList.add('active');
      document.querySelector('#emailToggle .toggle-text').textContent = 'ON';
      document.querySelector('#mainEmailToggle .toggle-text').textContent = 'ON';
    }
    
    // Load processed payments to avoid sending duplicate emails
    try {
      const processed = localStorage.getItem('processedPayments');
      if (processed) {
        const paymentArray = JSON.parse(processed);
        processedPayments = new Set(paymentArray);
      }
    } catch (error) {
      console.error('Error loading processed payments:', error);
      processedPayments = new Set();
    }
    
    // PIN functions
    function addDigit(digit) {
      if (pin.length < 4) {
        pin += digit;
        updatePinDisplay();
      }
    }
    
    function clearPin() {
      pin = '';
      updatePinDisplay();
    }
    
    function deleteDigit() {
      pin = pin.slice(0, -1);
      updatePinDisplay();
    }
    
    function updatePinDisplay() {
      pinDisplay.textContent = '*'.repeat(pin.length).padEnd(4, '*');
    }
    
    // Login/logout
    function login() {
      if (pin === ADMIN_PIN) {
        isLoggedIn = true;
        loginPanel.style.display = 'none';
        mainPanel.style.display = 'block';
        showToast('Logged in successfully', 'success');
        
        // Save login state
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('autoCall', autoCallEnabled ? 'true' : 'false');
        
        // Check connection and setup listeners
        setupFirebaseListeners();
        fetchPendingPayments();
        
        // Sync auto call toggle
        updateAutoCallUI();
        
        // Update email status
        updateEmailStatus();
      } else {
        showToast('Invalid PIN', 'error');
        playSound(errorSound);
        vibrate();
        clearPin();
      }
    }
    
    function logout() {
      isLoggedIn = false;
      mainPanel.style.display = 'none';
      loginPanel.style.display = 'block';
      clearPin();
      
      // Clear saved state
      localStorage.removeItem('isLoggedIn');
      
      // Reset data
      pendingPayments = [];
      notificationCount = 0;
      updateBadge();
      
      // Clear any active timers
      Object.keys(paymentTimers).forEach(id => {
        clearTimeout(paymentTimers[id]);
      });
      paymentTimers = {};
      
      showToast('Logged out', 'info');
    }
    
    // Toggle auto-call feature
    function toggleAutoCall() {
      autoCallEnabled = !autoCallEnabled;
      localStorage.setItem('autoCall', autoCallEnabled ? 'true' : 'false');
      updateAutoCallUI();
      showToast(`Auto-call ${autoCallEnabled ? 'enabled' : 'disabled'}`, 'info');
    }
    
    // Toggle email notifications
    function toggleEmailNotifications() {
      emailNotificationsEnabled = !emailNotificationsEnabled;
      
      // Update toggle UI
      emailToggle.classList.toggle('active', emailNotificationsEnabled);
      mainEmailToggle.classList.toggle('active', emailNotificationsEnabled);
      document.querySelector('#emailToggle .toggle-text').textContent = emailNotificationsEnabled ? 'ON' : 'OFF';
      document.querySelector('#mainEmailToggle .toggle-text').textContent = emailNotificationsEnabled ? 'ON' : 'OFF';
      
      // Save to local storage
      localStorage.setItem('emailNotifications', emailNotificationsEnabled);
      
      // Update status
      updateEmailStatus();
      
      showToast(emailNotificationsEnabled ? 'Email notifications enabled' : 'Email notifications disabled', 'info');
    }
    
    // Save email settings
    function saveEmailSettings() {
      const newEmail = mainPanel.style.display === 'none' ? 
        emailAddress.value : mainEmailAddress.value;
        
      if (!newEmail) {
        showToast('Please enter a valid email address', 'error');
        return;
      }
      
      userEmail = newEmail;
      localStorage.setItem('userEmail', userEmail);
      
      // Update both input fields
      emailAddress.value = userEmail;
      mainEmailAddress.value = userEmail;
      
      // Update status
      updateEmailStatus();
      
      showToast('Email settings saved!', 'success');
    }
    
    // Update email status text
    function updateEmailStatus() {
      if (emailStatus) {
        if (emailNotificationsEnabled && userEmail) {
          emailStatus.textContent = `Email notifications active: ${userEmail}`;
          emailStatus.style.color = '#4CAF50';
        } else if (!emailNotificationsEnabled && userEmail) {
          emailStatus.textContent = 'Email notifications are turned off';
          emailStatus.style.color = '#f44336';
        } else if (emailNotificationsEnabled && !userEmail) {
          emailStatus.textContent = 'Please enter your email address';
          emailStatus.style.color = '#ff6f00';
        } else {
          emailStatus.textContent = 'Email notifications disabled';
          emailStatus.style.color = '#aaa';
        }
      }
    }
    
    function updateAutoCallUI() {
      // Update both toggles
      autoCallToggle.className = autoCallEnabled ? 'auto-call-toggle active' : 'auto-call-toggle';
      mainAutoCallToggle.className = autoCallEnabled ? 'auto-call-toggle active' : 'auto-call-toggle';
      
      // Update text
      document.querySelector('#autoCallToggle .toggle-text').textContent = autoCallEnabled ? 'ON' : 'OFF';
      document.querySelector('#mainAutoCallToggle .toggle-text').textContent = autoCallEnabled ? 'ON' : 'OFF';
    }
    
    // Firebase listeners
    function setupFirebaseListeners() {
      // Connection status
      const connectedRef = database.ref('.info/connected');
      connectedRef.on('value', (snap) => {
        const connected = snap.val() === true;
        updateConnectionStatus(connected);
      });
      
      // Listen for new payments
      const pendingRef = database.ref('pendingPayments');
      pendingRef.on('child_added', async (snapshot) => {
        const payment = snapshot.val();
        console.log("New payment detected:", payment);
        
        if (payment) {
          // Check if we already have it in our list
          const existingIndex = pendingPayments.findIndex(p => p.id === payment.id);
          
          if (existingIndex === -1) {
            // Add timestamp for expiry calculation if not present
            if (!payment.receivedAt) {
              payment.receivedAt = Date.now();
            }
            
            // Add to pending payments
            pendingPayments.push(payment);
            updatePaymentsList(payment.id);
            
            // Show notification
            notificationCount++;
            updateBadge();
            
            if (isLoggedIn) {
              showPaymentNotification(payment);
              
              // Auto-call if enabled
              if (autoCallEnabled) {
                // Small delay before auto-calling
                setTimeout(() => {
                  callAdmin();
                }, 1000);
              }
            }
            
            // Start expiry timer
            startPaymentExpiryTimer(payment.id);
            
            // Check if not already processed for email
            if (!processedPayments.has(payment.id)) {
              processedPayments.add(payment.id);
              
              // Save processed payments to localStorage (limit to last 100)
              const processedArray = Array.from(processedPayments).slice(-100);
              localStorage.setItem('processedPayments', JSON.stringify(processedArray));
              
              // Send email notification if enabled
              if (emailNotificationsEnabled && userEmail) {
                await sendEmailNotification(payment);
              }
            }
          }
        }
      });
      
      // Listen for removed payments
      pendingRef.on('child_removed', (snapshot) => {
        const payment = snapshot.val();
        console.log("Payment removed:", payment);
        
        if (payment) {
          pendingPayments = pendingPayments.filter(p => p.id !== payment.id);
          updatePaymentsList();
          
          // Update badge
          notificationCount = Math.max(0, notificationCount - 1);
          updateBadge();
          
          // Hide alert if showing
          if (currentPaymentId === payment.id) {
            hideAlert();
          }
          
          // Clear any timer
          if (paymentTimers[payment.id]) {
            clearTimeout(paymentTimers[payment.id]);
            delete paymentTimers[payment.id];
          }
        }
      });
      
      // Listen for confirmed payments by ESP32
      const confirmedRef = database.ref('confirmedPayments');
      confirmedRef.on('child_added', (snapshot) => {
        const payment = snapshot.val();
        console.log("Payment confirmed:", payment);
        
        if (payment) {
          // Check if it's still in our pending list
          const pendingIndex = pendingPayments.findIndex(p => p.id === payment.id);
          
          if (pendingIndex !== -1) {
            // Add confirmation info
            pendingPayments[pendingIndex].confirmed = true;
            pendingPayments[pendingIndex].confirmedAt = payment.confirmedAt || new Date().toISOString();
            pendingPayments[pendingIndex].confirmedBy = payment.confirmedBy || 'ESP32';
            
            // Update the UI
            updatePaymentsList();
            
            // Show notification
            showToast(`Payment for ${payment.console} confirmed by ESP32!`, 'success');
            playSound(notificationSound);
            vibrate();
            
            // Clear expiry timer
            if (paymentTimers[payment.id]) {
              clearTimeout(paymentTimers[payment.id]);
              delete paymentTimers[payment.id];
            }
            
            // If this is the current alert, hide it
            if (currentPaymentId === payment.id) {
              hideAlert();
            }
          }
        }
      });
      
      // Listen for connection issues
      database.ref('.info/connected').on('value', (snap) => {
        const connected = snap.val() === true;
        
        if (!connected) {
          // Retry connection after a delay
          setTimeout(() => {
            console.log("Retrying connection...");
            database.goOnline();
          }, 5000);
        }
      });
      
      console.log("Firebase listeners setup complete");
    }
    
    // Start expiry timer for a payment
    function startPaymentExpiryTimer(paymentId) {
      // Clear any existing timer
      if (paymentTimers[paymentId]) {
        clearTimeout(paymentTimers[paymentId]);
      }
      
      console.log(`Starting expiry timer for payment ${paymentId}`);
      
      // Set new timer
      paymentTimers[paymentId] = setTimeout(() => {
        console.log(`Payment ${paymentId} expired after 2.5 minutes`);
        
        // Find the payment
        const payment = pendingPayments.find(p => p.id === paymentId);
        if (payment) {
          // Auto-cancel expired payment
          cancelPayment(paymentId, true);
          
          // Show notification
          showToast(`Payment for ${payment.console} expired and was auto-canceled`, 'error');
          playSound(errorSound);
          vibrate();
        }
      }, PAYMENT_EXPIRY_TIME);
    }
    
    // Format time in MM:SS format
    function formatTime(milliseconds) {
      const totalSeconds = Math.floor(milliseconds / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Update timer display for a payment
    function updatePaymentTimer(paymentId) {
      const payment = pendingPayments.find(p => p.id === paymentId);
      if (!payment || !payment.receivedAt) return;
      
      const timeElapsed = Date.now() - payment.receivedAt;
      const timeRemaining = Math.max(0, PAYMENT_EXPIRY_TIME - timeElapsed);
      const percentRemaining = (timeRemaining / PAYMENT_EXPIRY_TIME) * 100;
      
      // Update timer in alert modal if this is the current payment
      if (currentPaymentId === paymentId && alertModal.style.display === 'flex') {
        alertTimerBar.style.width = `${percentRemaining}%`;
        alertTimerText.textContent = `Expires in ${formatTime(timeRemaining)}`;
        
        // Highlight when less than 30 seconds remain
        if (timeRemaining < 30000) {
          alertTimerBar.style.backgroundColor = '#f44336';
          alertTimerText.style.color = '#f44336';
        } else {
          alertTimerBar.style.backgroundColor = '#ff6f00';
          alertTimerText.style.color = 'rgba(255,255,255,0.7)';
        }
      }
      
      // Update timer in payment card
      const timerBar = document.querySelector(`.payment-card[data-id="${paymentId}"] .timer-bar`);
      const timerText = document.querySelector(`.payment-card[data-id="${paymentId}"] .timer-text`);
      
      if (timerBar && timerText) {
        timerBar.style.width = `${percentRemaining}%`;
        timerText.textContent = `Expires in ${formatTime(timeRemaining)}`;
        
        // Highlight when less than 30 seconds remain
        if (timeRemaining < 30000) {
          const card = document.querySelector(`.payment-card[data-id="${paymentId}"]`);
          if (card) card.classList.add('expires-soon');
          timerBar.style.backgroundColor = '#f44336';
          timerText.style.color = '#f44336';
        }
      }
      
      // Continue updating if time remains
      if (timeRemaining > 0) {
        // Update every second
        setTimeout(() => updatePaymentTimer(paymentId), 1000);
      }
    }
    
    // Send email notification using EmailJS
    async function sendEmailNotification(payment) {
      try {
        if (!emailNotificationsEnabled || !userEmail) {
          return;
        }
        
        // Format time nicely
        const time = new Date().toLocaleTimeString([], { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: true 
        });
        
        // Prepare email parameters
        const templateParams = {
          to_email: userEmail,
          subject: `üéÆ New Payment: ${payment.console} - ‚Çπ${payment.amount}`,
          console_name: payment.console,
          amount: payment.amount,
          minutes: payment.minutes,
          players: payment.players || 1,
          payment_method: payment.method || "Unknown",
          time: time,
          admin_phone: ADMIN_PHONE
        };
        
        // Send email using EmailJS
        const response = await emailjs.send(
          'service_6rti90s', // Replace with your EmailJS service ID
          'template_qsz908i', // Replace with your EmailJS template ID
          templateParams
        );
        
        console.log('Email notification sent:', response.status);
        showToast('Email notification sent successfully', 'success');
        return true;
      } catch (error) {
        console.error('Error sending email:', error);
        showToast('Failed to send email notification', 'error');
        return false;
      }
    }
    
    // Fetch payments
    function fetchPendingPayments() {
      showToast('Loading payments...', 'info');
      
      database.ref('pendingPayments').once('value', (snapshot) => {
        const data = snapshot.val();
        
        if (data) {
          pendingPayments = Object.values(data);
          
          // Add receivedAt for any payments that don't have it
          pendingPayments.forEach(payment => {
            if (!payment.receivedAt) {
              payment.receivedAt = Date.now();
            }
            
            // Start timer for each payment
            startPaymentExpiryTimer(payment.id);
          });
          
          notificationCount = pendingPayments.length;
          updateBadge();
          updatePaymentsList();
          
          showToast(`Found ${pendingPayments.length} payments`, 'success');
        } else {
          pendingPayments = [];
          notificationCount = 0;
          updateBadge();
          updatePaymentsList();
          
          showToast('No pending payments', 'info');
        }
      });
    }
    
    // Update payments list
    function updatePaymentsList(highlightId = null) {
      if (pendingPayments.length === 0) {
        paymentsContainer.innerHTML = '<div class="no-items">No pending payments</div>';
        return;
      }
      
      // Sort by newest first
      const sortedPayments = [...pendingPayments].sort(
        (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
      );
      
      let html = '';
      sortedPayments.forEach(payment => {
        const isHighlighted = payment.id === highlightId ? 'new' : '';
        const time = new Date(payment.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Calculate time remaining
        let timeElapsed = 0;
        let timeRemaining = PAYMENT_EXPIRY_TIME;
        let percentRemaining = 100;
        
        if (payment.receivedAt) {
          timeElapsed = Date.now() - payment.receivedAt;
          timeRemaining = Math.max(0, PAYMENT_EXPIRY_TIME - timeElapsed);
          percentRemaining = (timeRemaining / PAYMENT_EXPIRY_TIME) * 100;
        }
        
        // Create status badge based on payment status
        let statusBadge = '';
        if (payment.confirmed) {
          statusBadge = '<div class="payment-status-badge confirmed-badge">Auto-confirmed</div>';
        } else if (timeRemaining <= 0) {
          statusBadge = '<div class="payment-status-badge expired-badge">Expired</div>';
        } else if (timeRemaining < 30000) { // Less than 30 seconds
          statusBadge = '<div class="payment-status-badge detecting-badge">Detecting...</div>';
        } else {
          statusBadge = '<div class="payment-status-badge waiting-badge">Waiting</div>';
        }
        
        html += `
          <div class="payment-card ${isHighlighted} ${timeRemaining < 30000 ? 'expires-soon' : ''}" data-id="${payment.id}">
            ${statusBadge}
            <div class="payment-header">
              <div class="payment-console">${payment.console}</div>
              <div class="payment-time">${time}</div>
            </div>
            <div class="payment-info">
              <div class="info-row">
                <div class="info-label">Duration:</div>
                <div class="info-value">${payment.minutes} min</div>
              </div>
              <div class="info-row">
                <div class="info-label">Players:</div>
                <div class="info-value">${payment.players || 1}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Amount:</div>
                <div class="amount">‚Çπ${payment.amount}</div>
              </div>
            </div>
            
            <!-- Timer bar -->
            <div class="timer-bar-container">
              <div class="timer-bar" style="width: ${percentRemaining}%"></div>
            </div>
            <div class="timer-text">Expires in ${formatTime(timeRemaining)}</div>
            
            <div class="payment-actions">
              <div class="action-btn btn-call" onclick="callAdmin()">Call</div>
            </div>
            <div class="payment-actions">
              <div class="action-btn btn-confirm" onclick="confirmPayment('${payment.id}')">Confirm</div>
              <div class="action-btn btn-cancel" onclick="cancelPayment('${payment.id}')">Cancel</div>
            </div>
          </div>
        `;
      });
      
      paymentsContainer.innerHTML = html;
      
      // Start timer updates for all visible payments
      sortedPayments.forEach(payment => {
        updatePaymentTimer(payment.id);
      });
    }
    
    // Confirm/cancel payment
    function confirmPayment(paymentId) {
      const payment = pendingPayments.find(p => p.id === paymentId);
      if (!payment) return;
      
      showToast('Confirming payment...', 'info');
      
      // First move to confirmed
      database.ref(`confirmedPayments/${paymentId}`).set({
        ...payment,
        confirmedAt: new Date().toISOString(),
        confirmedBy: 'Admin'
      })
        .then(() => {
          // Then remove from pending
          return database.ref(`pendingPayments/${paymentId}`).remove();
        })
        .then(() => {
          showToast('Payment confirmed', 'success');
          
          // Clear expiry timer
          if (paymentTimers[paymentId]) {
            clearTimeout(paymentTimers[paymentId]);
            delete paymentTimers[paymentId];
          }
        })
        .catch(error => {
          console.error("Error confirming payment:", error);
          showToast('Failed to confirm', 'error');
        });
    }
    
    function cancelPayment(paymentId, isExpired = false) {
      const payment = pendingPayments.find(p => p.id === paymentId);
      if (!payment) return;
      
      showToast(isExpired ? 'Payment expired...' : 'Canceling payment...', 'info');
      
      // First move to canceled
      database.ref(`canceledPayments/${paymentId}`).set({
        ...payment,
        canceledAt: new Date().toISOString(),
        canceledBy: isExpired ? 'Timeout' : 'Admin',
        reason: isExpired ? 'Payment expired after 2.5 minutes' : 'Canceled by admin'
      })
        .then(() => {
          // Then remove from pending
          return database.ref(`pendingPayments/${paymentId}`).remove();
        })
        .then(() => {
          showToast(isExpired ? 'Payment expired and canceled' : 'Payment canceled', 'info');
          
          // Clear expiry timer
          if (paymentTimers[paymentId]) {
            clearTimeout(paymentTimers[paymentId]);
            delete paymentTimers[paymentId];
          }
        })
        .catch(error => {
          console.error("Error canceling payment:", error);
          showToast('Failed to cancel', 'error');
        });
    }
    
    // Call admin function - this initiates the phone call
    function callAdmin() {
      // Clear any existing timer
      if (callTimerId) {
        clearInterval(callTimerId);
        callTimerId = null;
        callTimer.style.display = 'none';
      }
      
      // Start call by opening the tel: URI
      window.location.href = `tel:${ADMIN_PHONE}`;
      showToast('Calling admin...', 'info');
      
      // Show timer
      callTimer.style.display = 'block';
      let secondsLeft = CALL_DURATION;
      timeLeft.textContent = secondsLeft;
      
      // Start countdown timer
      callTimerId = setInterval(() => {
        secondsLeft--;
        timeLeft.textContent = secondsLeft;
        
        if (secondsLeft <= 0) {
          clearInterval(callTimerId);
          callTimerId = null;
          callTimer.style.display = 'none';
        }
      }, 1000);
    }
    
    // Show payment notification
    function showPaymentNotification(payment) {
      // Try to play sound first - iOS requires user interaction
      if (soundEnabled) {
        playSound(notificationSound);
      }
      
      // Try to vibrate
      vibrate();
      
      // Show toast notification
      const notificationTitle = document.querySelector('.notification-title');
      const notificationMessage = document.querySelector('.notification-message');
      
      notificationTitle.textContent = 'New Payment';
      notificationMessage.textContent = `${payment.console} - ‚Çπ${payment.amount}`;
      
      notification.classList.add('show');
      
      // Tap on notification to show alert
      notification.onclick = () => {
        notification.classList.remove('show');
        showAlert(payment);
      };
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        notification.classList.remove('show');
      }, 5000);
      
      // Show alert modal automatically
      setTimeout(() => {
        showAlert(payment);
      }, 500);
    }
    
    // Show alert modal
    function showAlert(payment) {
      currentPaymentId = payment.id;
      
      alertConsole.textContent = payment.console;
      alertDuration.textContent = `${payment.minutes} min`;
      alertPlayers.textContent = payment.players || 1;
      alertAmount.textContent = `‚Çπ${payment.amount}`;
      
      // Initialize timer bar
      if (payment.receivedAt) {
        const timeElapsed = Date.now() - payment.receivedAt;
        const timeRemaining = Math.max(0, PAYMENT_EXPIRY_TIME - timeElapsed);
        const percentRemaining = (timeRemaining / PAYMENT_EXPIRY_TIME) * 100;
        
        alertTimerBar.style.width = `${percentRemaining}%`;
        alertTimerText.textContent = `Expires in ${formatTime(timeRemaining)}`;
        
        // Start timer updates
        updatePaymentTimer(payment.id);
      } else {
        // Default to full time if no receivedAt
        alertTimerBar.style.width = '100%';
        alertTimerText.textContent = 'Expires in 2:30';
      }
      
      // Set button actions
      alertConfirm.onclick = () => {
        confirmPayment(payment.id);
        hideAlert();
      };
      
      alertCancel.onclick = () => {
        cancelPayment(payment.id);
        hideAlert();
      };
      
      alertModal.style.display = 'flex';
    }
    
    // Hide alert modal
    function hideAlert() {
            alertModal.style.display = 'none';
    }
    
    // Process payment function
    function processPayment(paymentId) {
      // Show loading state
      document.getElementById('paymentStatus').textContent = 'Processing...';
      
      // Simulate API call to process payment
      fetch(`/api/payments/${paymentId}/process`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showSuccessMessage(`Payment #${paymentId} processed successfully`);
          updatePaymentList();
        } else {
          showErrorMessage(`Failed to process payment: ${data.message}`);
        }
      })
      .catch(error => {
        showErrorMessage(`Error: ${error.message}`);
        console.error('Payment processing error:', error);
      });
    }
    
    // Cancel payment function
    function cancelPayment(paymentId) {
      // Show loading state
      document.getElementById('paymentStatus').textContent = 'Cancelling...';
      
      // Simulate API call to cancel payment
      fetch(`/api/payments/${paymentId}/cancel`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showSuccessMessage(`Payment #${paymentId} cancelled successfully`);
          updatePaymentList();
        } else {
          showErrorMessage(`Failed to cancel payment: ${data.message}`);
        }
      })
      .catch(error => {
        showErrorMessage(`Error: ${error.message}`);
        console.error('Payment cancellation error:', error);
      });
    }
    
    // Show success message
    function showSuccessMessage(message) {
      const statusElement = document.getElementById('paymentStatus');
      statusElement.textContent = message;
      statusElement.className = 'success';
      setTimeout(() => {
        statusElement.textContent = '';
        statusElement.className = '';
      }, 3000);
    }
    
    // Show error message
    function showErrorMessage(message) {
      const statusElement = document.getElementById('paymentStatus');
      statusElement.textContent = message;
      statusElement.className = 'error';
      setTimeout(() => {
        statusElement.textContent = '';
        statusElement.className = '';
      }, 3000);
    }
    
    // Update payment list
    function updatePaymentList() {
      fetch('/api/payments')
        .then(response => response.json())
        .then(payments => {
          const paymentList = document.getElementById('paymentList');
          paymentList.innerHTML = '';
          
          payments.forEach(payment => {
            const paymentItem = document.createElement('div');
            paymentItem.className = 'payment-item';
            paymentItem.innerHTML = `
              <div class="payment-info">
                <h3>Payment #${payment.id}</h3>
                <p>Amount: $${payment.amount.toFixed(2)}</p>
                <p>Status: <span class="status-${payment.status.toLowerCase()}">${payment.status}</span></p>
                <p>Date: ${new Date(payment.date).toLocaleDateString()}</p>
              </div>
              <div class="payment-actions">
                ${payment.status === 'PENDING' ? `
                  <button onclick="showConfirmation(${JSON.stringify(payment).replace(/"/g, '&quot;')}, 'process')">Process</button>
                  <button onclick="showConfirmation(${JSON.stringify(payment).replace(/"/g, '&quot;')}, 'cancel')">Cancel</button>
                ` : ''}
              </div>
            `;
            paymentList.appendChild(paymentItem);
          });
        })
        .catch(error => {
          console.error('Error fetching payments:', error);
          showErrorMessage('Failed to load payments');
        });
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      updatePaymentList();
      
      // Initialize alert modal close button
      document.querySelector('.alert-close').addEventListener('click', hideAlert);
    });
  </script>
</body>
</html>
