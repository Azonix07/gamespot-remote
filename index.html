<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gamespot Remote Control</title>
  
  <!-- Use Bootstrap for reliable CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Add custom styles with !important to override any conflicts -->
  <style>
    body {
      background-color: #121212 !important;
      color: white !important;
      font-family: Arial, sans-serif !important;
      padding-top: 70px !important;
    }
    
    .header-fixed {
      position: fixed !important;
      top: 0 !important;
      right: 0 !important;
      left: 0 !important;
      z-index: 1030 !important;
      background-color: #1e1e2f !important;
      border-bottom: 2px solid #ff6f00 !important;
    }
    
    .orange-text {
      color: #ff6f00 !important;
    }
    
    .card {
      background-color: #1e1e2f !important;
      border: 1px solid rgba(255, 111, 0, 0.3) !important;
      margin-bottom: 15px !important;
    }
    
    .pin-display {
      background-color: #000 !important;
      color: white !important;
      font-size: 24px !important;
      letter-spacing: 8px !important;
      text-align: center !important;
      padding: 15px !important;
      border-radius: 5px !important;
      margin-bottom: 20px !important;
    }
    
    .keypad-btn {
      background-color: rgba(255, 111, 0, 0.2) !important;
      border: 1px solid rgba(255, 111, 0, 0.5) !important;
      color: white !important;
      font-size: 24px !important;
      padding: 15px !important;
    }
    
    .keypad-btn:active {
      background-color: rgba(255, 111, 0, 0.5) !important;
      transform: scale(0.95) !important;
    }
    
    .action-btn {
      background-color: rgba(255, 111, 0, 0.2) !important;
      border: 1px solid rgba(255, 111, 0, 0.5) !important;
      color: white !important;
      padding: 15px !important;
      text-align: center !important;
      margin-bottom: 10px !important;
      cursor: pointer !important;
    }
    
    .action-btn:hover {
      background-color: rgba(255, 111, 0, 0.4) !important;
    }
    
    .btn-orange {
      background-color: #ff6f00 !important;
      color: white !important;
    }
    
    .status-indicator {
      display: inline-block !important;
      width: 10px !important;
      height: 10px !important;
      border-radius: 50% !important;
    }
    
    .online {
      background-color: #4CAF50 !important;
      box-shadow: 0 0 5px #4CAF50 !important;
    }
    
    .offline {
      background-color: #f44336 !important;
      box-shadow: 0 0 5px #f44336 !important;
    }
    
    .payment-card {
      background-color: rgba(0, 0, 0, 0.2) !important;
      border-radius: 8px !important;
      padding: 15px !important;
      margin-bottom: 15px !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
    }
    
    .notification-badge {
      position: fixed !important;
      top: 65px !important;
      right: 10px !important;
      background: #f44336 !important;
      color: white !important;
      min-width: 20px !important;
      height: 20px !important;
      border-radius: 10px !important;
      text-align: center !important;
      line-height: 20px !important;
      font-size: 12px !important;
      font-weight: bold !important;
      display: none !important;
      z-index: 1000 !important;
      padding: 0 5px !important;
    }
    
    .sound-toggle {
      width: 30px !important;
      height: 30px !important;
      background: rgba(255, 255, 255, 0.1) !important;
      border-radius: 50% !important;
      display: flex !important;
      justify-content: center !important;
      align-items: center !important;
      cursor: pointer !important;
      font-size: 18px !important;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header-fixed p-3 d-flex justify-content-between align-items-center">
    <div>
      <h3 class="m-0 orange-text">Gamespot Remote</h3>
    </div>
    <div class="d-flex align-items-center">
      <span class="status-indicator offline me-2" id="connectionStatus"></span>
      <span id="statusText">Offline</span>
      <div class="sound-toggle ms-3" id="soundToggle">ðŸ””</div>
    </div>
  </div>

  <!-- Notification Badge -->
  <div class="notification-badge" id="notificationBadge">0</div>
  
  <div class="container mt-4">
    <!-- Login Panel -->
    <div id="loginPanel" class="card p-4">
      <h2 class="text-center orange-text mb-4">Admin Login</h2>
      <div class="pin-display mb-4" id="pinDisplay">****</div>
      
      <div class="row g-2 mb-3">
        <div class="col-4"><button class="btn keypad-btn w-100" onclick="addDigit(1)">1</button></div>
        <div class="col-4"><button class="btn keypad-btn w-100" onclick="addDigit(2)">2</button></div>
        <div class="col-4"><button class="btn keypad-btn w-100" onclick="addDigit(3)">3</button></div>
        <div class="col-4"><button class="btn keypad-btn w-100" onclick="addDigit(4)">4</button></div>
        <div class="col-4"><button class="btn keypad-btn w-100" onclick="addDigit(5)">5</button></div>
        <div class="col-4"><button class="btn keypad-btn w-100" onclick="addDigit(6)">6</button></div>
        <div class="col-4"><button class="btn keypad-btn w-100" onclick="addDigit(7)">7</button></div>
        <div class="col-4"><button class="btn keypad-btn w-100" onclick="addDigit(8)">8</button></div>
        <div class="col-4"><button class="btn keypad-btn w-100" onclick="addDigit(9)">9</button></div>
        <div class="col-4"><button class="btn keypad-btn w-100" onclick="clearPin()">Clear</button></div>
        <div class="col-4"><button class="btn keypad-btn w-100" onclick="addDigit(0)">0</button></div>
        <div class="col-4"><button class="btn keypad-btn w-100" onclick="deleteDigit()">âŒ«</button></div>
      </div>
      
      <button class="btn btn-orange w-100 py-3" onclick="login()">Login</button>
    </div>
    
    <!-- Control Panel -->
    <div id="controlPanel" class="d-none">
      <div class="card mb-4">
        <div class="card-header orange-text">
          <h3 class="m-0">Pending Payments</h3>
        </div>
        <div class="card-body" id="paymentsList">
          <div class="text-center p-3">No pending payments</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header orange-text">
          <h3 class="m-0">Quick Actions</h3>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-6"><div class="action-btn rounded" onclick="refreshPayments()">Refresh</div></div>
            <div class="col-6"><div class="action-btn rounded" onclick="backToHome()">Home</div></div>
            <div class="col-6"><div class="action-btn rounded" onclick="checkStatus()">Check Status</div></div>
            <div class="col-6"><div class="action-btn rounded" onclick="resetAll()">Reset All</div></div>
          </div>
          <button class="btn btn-secondary w-100 mt-3" onclick="logout()">Logout</button>
        </div>
      </div>
    </div>
    
    <!-- Payment Alert -->
    <div class="modal fade" id="paymentAlertModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-white border-warning">
          <div class="modal-header border-warning">
            <h5 class="modal-title orange-text">New UPI Payment</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>Console: <span id="alertConsole">PS5 #1</span></p>
            <p>Duration: <span id="alertDuration">60 min</span></p>
            <p>Players: <span id="alertPlayers">2</span></p>
            <div class="text-center my-3">
              <h3 class="orange-text">â‚¹<span id="alertAmount">150</span></h3>
            </div>
          </div>
          <div class="modal-footer border-warning">
            <button type="button" class="btn btn-danger" id="alertCancel">Cancel</button>
            <button type="button" class="btn btn-success" id="alertConfirm">Confirm</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Audio for notifications -->
  <audio id="notificationSound" preload="auto">
    <source src="https://raw.githubusercontent.com/twbs/bootstrap/main/site/assets/js/vendor/notification.mp3" type="audio/mp3">
  </audio>
  
  <!-- Toast notifications -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header" id="toastHeader">
        <strong class="me-auto" id="toastTitle">Notification</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script>
    // Configuration
    const ADMIN_PIN = '6006';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDUIUj6uvUfWVxyHfgLWzahJAelrFqpIEc",
      authDomain: "gamespotkiosk.firebaseapp.com",
      databaseURL: "https://gamespotkiosk-default-rtdb.firebaseio.com",
      projectId: "gamespotkiosk",
      storageBucket: "gamespotkiosk.appspot.com",
      messagingSenderId: "537976874541",
      appId: "1:537976874541:web:9e847488e9fc6b78913aa4",
      measurementId: "G-SGD83SS6D1"
    };
    
    // Initialize Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      console.log("Firebase initialized successfully");
    } catch (error) {
      console.error("Firebase initialization error:", error);
      alert("Could not connect to Firebase. Check console for details.");
    }
    
    // Get database reference
    const database = firebase.database();
    
    // DOM elements
    const loginPanel = document.getElementById('loginPanel');
    const controlPanel = document.getElementById('controlPanel');
    const pinDisplay = document.getElementById('pinDisplay');
    const paymentsList = document.getElementById('paymentsList');
    const connectionStatus = document.getElementById('connectionStatus');
    const statusText = document.getElementById('statusText');
    const notificationBadge = document.getElementById('notificationBadge');
    const soundToggle = document.getElementById('soundToggle');
    const notificationSound = document.getElementById('notificationSound');
    
    // Alert elements
    const alertConsole = document.getElementById('alertConsole');
    const alertDuration = document.getElementById('alertDuration');
    const alertPlayers = document.getElementById('alertPlayers');
    const alertAmount = document.getElementById('alertAmount');
    const alertConfirm = document.getElementById('alertConfirm');
    const alertCancel = document.getElementById('alertCancel');
    
    // Bootstrap modal
    let paymentAlertModal;
    
    // State variables
    let pin = '';
    let pendingPayments = [];
    let notificationCount = 0;
    let soundEnabled = true;
    let currentPaymentId = null;
    
    // PIN functions
    function addDigit(digit) {
      if (pin.length < 4) {
        pin += digit;
        updatePinDisplay();
      }
    }
    
    function clearPin() {
      pin = '';
      updatePinDisplay();
    }
    
    function deleteDigit() {
      pin = pin.slice(0, -1);
      updatePinDisplay();
    }
    
    function updatePinDisplay() {
      pinDisplay.textContent = '*'.repeat(pin.length).padEnd(4, '*');
    }
    
    // Login/logout
    function login() {
      if (pin === ADMIN_PIN) {
        loginPanel.style.display = 'none';
        controlPanel.classList.remove('d-none');
        
        // Save login status
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('adminPin', pin);
        
        showToast('Login successful', 'Success', 'success');
        
        // Start listening for payments
        listenForPayments();
        fetchPendingPayments();
      } else {
        showToast('Invalid PIN', 'Error', 'danger');
        clearPin();
      }
    }
    
    function logout() {
      loginPanel.style.display = 'block';
      controlPanel.classList.add('d-none');
      pin = '';
      updatePinDisplay();
      
      // Clear saved login
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('adminPin');
      
      // Stop listening for payments
      database.ref('pendingPayments').off();
      
      showToast('Logged out successfully', 'Info', 'info');
    }
    
    // Firebase listeners
    function listenForPayments() {
      try {
        // Listen for new payments
        database.ref('pendingPayments').on('child_added', snapshot => {
          const payment = snapshot.val();
          if (payment) {
            console.log('New payment received:', payment);
            pendingPayments.push(payment);
            updatePaymentsList();
            
            // Show notification
            notificationCount++;
            notificationBadge.textContent = notificationCount;
            notificationBadge.style.display = 'block';
            
            // Show alert
            showPaymentAlert(payment);
          }
        });
        
        // Listen for removed payments
        database.ref('pendingPayments').on('child_removed', snapshot => {
          const payment = snapshot.val();
          if (payment) {
            console.log('Payment removed:', payment);
            pendingPayments = pendingPayments.filter(p => p.id !== payment.id);
            updatePaymentsList();
          }
        });
        
        // Update connection status
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', snap => {
          const connected = !!snap.val();
          console.log('Connection status:', connected ? 'online' : 'offline');
          updateConnectionStatus(connected);
        });
      } catch (error) {
        console.error('Error setting up listeners:', error);
        showToast('Failed to connect to database', 'Error', 'danger');
      }
    }
    
    // Payment handling
    async function fetchPendingPayments() {
      try {
        console.log('Fetching pending payments...');
        const snapshot = await database.ref('pendingPayments').once('value');
        const paymentsObj = snapshot.val() || {};
        
        pendingPayments = Object.values(paymentsObj);
        console.log('Pending payments:', pendingPayments);
        updatePaymentsList();
        
        // Update notification badge
        if (pendingPayments.length > 0) {
          notificationCount = pendingPayments.length;
          notificationBadge.textContent = notificationCount;
          notificationBadge.style.display = 'block';
        } else {
          notificationCount = 0;
          notificationBadge.style.display = 'none';
        }
      } catch (error) {
        console.error('Error fetching payments:', error);
        showToast('Failed to load payments', 'Error', 'danger');
      }
    }
    
    function updatePaymentsList() {
      if (!pendingPayments || pendingPayments.length === 0) {
        paymentsList.innerHTML = '<div class="text-center p-3">No pending payments</div>';
        return;
      }
      
      let html = '';
      pendingPayments.forEach(payment => {
        const time = new Date(payment.createdAt).toLocaleTimeString();
        
        html += `
          <div class="payment-card">
            <div class="d-flex justify-content-between mb-3">
              <div class="fw-bold">${payment.console}</div>
              <div class="badge bg-dark">${time}</div>
            </div>
            
            <div class="row mb-3">
              <div class="col-6"><span class="text-muted">Duration:</span> ${payment.minutes} min</div>
              <div class="col-6"><span class="text-muted">Method:</span> ${payment.method}</div>
              <div class="col-6"><span class="text-muted">Players:</span> ${payment.players || 1}</div>
              <div class="col-6"><span class="text-muted">Amount:</span> <span class="orange-text">â‚¹${payment.amount}</span></div>
            </div>
            
            <div class="d-flex gap-2">
              <button class="btn btn-success flex-grow-1" onclick="confirmPayment('${payment.id}')">Confirm</button>
              <button class="btn btn-danger flex-grow-1" onclick="cancelPayment('${payment.id}')">Cancel</button>
            </div>
          </div>
        `;
      });
      
      paymentsList.innerHTML = html;
    }
    
    async function confirmPayment(paymentId) {
      try {
        showToast('Confirming payment...', 'Processing', 'info');
        
        const payment = pendingPayments.find(p => p.id === paymentId);
        if (!payment) {
          throw new Error('Payment not found');
        }
        
        console.log('Confirming payment:', payment);
        
        // Move to confirmed payments
        await database.ref(`confirmedPayments/${paymentId}`).set(payment);
        
        // Remove from pending
        await database.ref(`pendingPayments/${paymentId}`).remove();
        
        showToast('Payment confirmed successfully', 'Success', 'success');
        
        // Update notification count
        notificationCount = Math.max(0, notificationCount - 1);
        if (notificationCount === 0) {
          notificationBadge.style.display = 'none';
        } else {
          notificationBadge.textContent = notificationCount;
        }
        
        // Hide modal if this payment is showing
        if (currentPaymentId === paymentId && paymentAlertModal) {
          paymentAlertModal.hide();
          currentPaymentId = null;
        }
      } catch (error) {
        console.error('Error confirming payment:', error);
        showToast('Failed to confirm payment', 'Error', 'danger');
      }
    }
    
    async function cancelPayment(paymentId) {
      try {
        showToast('Canceling payment...', 'Processing', 'info');
        
        const payment = pendingPayments.find(p => p.id === paymentId);
        if (!payment) {
          throw new Error('Payment not found');
        }
        
        console.log('Canceling payment:', payment);
        
        // Move to canceled payments
        await database.ref(`canceledPayments/${paymentId}`).set(payment);
        
        // Remove from pending
        await database.ref(`pendingPayments/${paymentId}`).remove();
        
        showToast('Payment canceled', 'Info', 'warning');
        
        // Update notification count
        notificationCount = Math.max(0, notificationCount - 1);
        if (notificationCount === 0) {
          notificationBadge.style.display = 'none';
        } else {
          notificationBadge.textContent = notificationCount;
        }
        
        // Hide modal if this payment is showing
        if (currentPaymentId === paymentId && paymentAlertModal) {
          paymentAlertModal.hide();
          currentPaymentId = null;
        }
      } catch (error) {
        console.error('Error canceling payment:', error);
        showToast('Failed to cancel payment', 'Error', 'danger');
      }
    }
    
    // Show payment alert
    function showPaymentAlert(payment) {
      if (!paymentAlertModal) {
        paymentAlertModal = new bootstrap.Modal(document.getElementById('paymentAlertModal'));
      }
      
      currentPaymentId = payment.id;
      
      // Update alert content
      alertConsole.textContent = payment.console;
      alertDuration.textContent = `${payment.minutes} min`;
      alertPlayers.textContent = payment.players || 1;
      alertAmount.textContent = payment.amount;
      
      // Set button actions
      alertConfirm.onclick = () => confirmPayment(payment.id);
      alertCancel.onclick = () => cancelPayment(payment.id);
      
      // Play notification sound if enabled
      if (soundEnabled) {
        notificationSound.play().catch(e => console.log('Error playing sound:', e));
      }
      
      // Make the phone vibrate
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
      }
      
      // Show the modal
      paymentAlertModal.show();
    }
    
    // Connection management
    function updateConnectionStatus(connected) {
      connectionStatus.classList.toggle('online', connected);
      connectionStatus.classList.toggle('offline', !connected);
      statusText.textContent = connected ? 'Connected' : 'Offline';
    }
    
    // Utility functions
    function refreshPayments() {
      showToast('Refreshing payments...', 'Info', 'info');
      fetchPendingPayments();
    }
    
    function backToHome() {
      showToast('Redirecting kiosks to home...', 'Info', 'info');
      database.ref('commands').push({
        type: 'redirect',
        page: 'index.html',
        timestamp: Date.now()
      });
    }
    
    function checkStatus() {
      showToast('All systems operational', 'System Status', 'success');
    }
    
    function resetAll() {
      if (!confirm('Are you sure you want to reset all devices?')) {
        return;
      }
      
      showToast('Resetting all devices...', 'Info', 'info');
      
      database.ref('commands').push({
        type: 'reset',
        timestamp: Date.now()
      });
    }
    
    // Sound toggle
    soundToggle.addEventListener('click', function() {
      soundEnabled = !soundEnabled;
      this.textContent = soundEnabled ? 'ðŸ””' : 'ðŸ”•';
      showToast(soundEnabled ? 'Sound notifications enabled' : 'Sound notifications disabled', 'Info', 'info');
    });
    
    // Show toast notification
    function showToast(message, title, type) {
      const toast = document.getElementById('toast');
      const toastHeader = document.getElementById('toastHeader');
      const toastTitle = document.getElementById('toastTitle');
      const toastBody = document.getElementById('toastBody');
      
      // Set content
      toastTitle.textContent = title;
      toastBody.textContent = message;
      
      // Set color based on type
      toastHeader.className = 'toast-header bg-' + type + ' text-white';
      
      // Show the toast
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Page loaded');
      
      // Check for saved login
      if (localStorage.getItem('isLoggedIn') === 'true') {
        pin = ADMIN_PIN;
        login();
      }
    });
  </script>
</body>
</html>
